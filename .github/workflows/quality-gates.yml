name: Quality Gates

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java (Spring Boot)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Compute changed files
        shell: bash
        run: |
          set -euo pipefail

          safe_diff_name_only() {
            local before_sha="$1"
            local after_sha="$2"
            local default_branch="${{ github.event.repository.default_branch }}"
            if [ -z "${default_branch}" ]; then
              default_branch="main"
            fi

            if [ "${before_sha}" = "0000000000000000000000000000000000000000" ]; then
              git diff --name-only --root "${after_sha}" > changed_files.txt
              return 0
            fi

            if git cat-file -e "${before_sha}^{commit}" 2>/dev/null; then
              git diff --name-only "${before_sha}" "${after_sha}" > changed_files.txt
              return 0
            fi

            echo "warning: before SHA 不可达（${before_sha}），改用 merge-base 回退计算 diff。"
            git fetch --no-tags origin "${default_branch}" --depth=1 >/dev/null 2>&1 || true
            default_ref="origin/${default_branch}"
            if ! git show-ref --verify --quiet "refs/remotes/${default_ref}"; then
              default_ref="HEAD~1"
            fi
            base_commit="$(git merge-base "${default_ref}" "${after_sha}" 2>/dev/null || true)"
            if [ -n "${base_commit}" ]; then
              git diff --name-only "${base_commit}" "${after_sha}" > changed_files.txt
            else
              git diff-tree --no-commit-id --name-only -r "${after_sha}" > changed_files.txt
            fi
          }

          EVENT_NAME="${{ github.event_name }}"
          : > changed_files.txt

          if [ "${EVENT_NAME}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            if [ -z "${BASE_SHA}" ] || [ -z "${HEAD_SHA}" ]; then
              echo "pull_request 事件但 base/head sha 为空，无法计算 diff。" >&2
              exit 1
            fi

            git diff --name-only "${BASE_SHA}...${HEAD_SHA}" > changed_files.txt
          else
            BEFORE_SHA="${{ github.event.before }}"
            AFTER_SHA="${{ github.sha }}"
            safe_diff_name_only "${BEFORE_SHA}" "${AFTER_SHA}"
          fi

          echo "Changed files:"
          cat changed_files.txt || true

      - name: Require CODEOWNERS baseline for owner review
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f ".github/CODEOWNERS" ] && [ ! -f "CODEOWNERS" ] && [ ! -f "docs/CODEOWNERS" ]; then
            echo "缺少 CODEOWNERS。AGENTS.md 要求建立 Owner 机制（建议在 .github/CODEOWNERS 配置）。"
            echo "下一步：新增 .github/CODEOWNERS（或仓库根 CODEOWNERS）并提交。"
            exit 1
          fi

      - name: Install dependencies (best effort for Node/Python)
        shell: bash
        run: |
          set -euo pipefail

          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
          fi

          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          fi

          if [ -f requirements-dev.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements-dev.txt
          fi

      - name: Secrets scan (gitleaks)
        shell: bash
        run: |
          set -euo pipefail

          # gitleaks-action@v2 requires a license key for organizations; run the OSS scanner via container instead.
          # This remains a hard gate: any finding must fail the workflow.
          docker run --rm \
            -v "${PWD}:/repo" \
            -w /repo \
            ghcr.io/gitleaks/gitleaks:latest \
            detect --source=/repo --redact

      - name: Block debug print statements in production code paths
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -s changed_files.txt ]; then
            echo "无文件变更，跳过。"
            exit 0
          fi

          code_paths_regex='^(modules|apps|services|src)/'
          code_file_regex='\.(java|kt|js|jsx|ts|tsx|py|go|rb|php|cs|scala)$'

          : > debug_hits.txt
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            echo "$f" | grep -E "${code_paths_regex}" >/dev/null || continue
            echo "$f" | grep -E "${code_file_regex}" >/dev/null || continue
            echo "$f" | grep -E '(^|/)(test|tests|__tests__|spec|specs)/' >/dev/null && continue

            grep -nE '\b(console\.log|print\(|System\.out\.println\()' "$f" >> debug_hits.txt || true
          done < changed_files.txt

          if [ -s debug_hits.txt ]; then
            echo "检测到标准输出调试语句（禁止进入生产代码）："
            cat debug_hits.txt
            exit 1
          fi

          echo "未检测到标准输出调试语句。"

      - name: Enforce architecture dependency direction (CAP-004)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -x "scripts/ci/arch-check.sh" ]; then
            echo "缺少可执行脚本：scripts/ci/arch-check.sh"
            echo "下一步：补齐 CAP-004 门禁脚本并赋权：chmod +x scripts/ci/arch-check.sh"
            exit 1
          fi

          mkdir -p artifacts/ci/arch-check
          scripts/ci/arch-check.sh --out artifacts/ci/arch-check

      - name: Run gate self-tests (CAP-010)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -x "scripts/ci/gate-selftest.sh" ]; then
            echo "缺少可执行脚本：scripts/ci/gate-selftest.sh"
            echo "下一步：补齐门禁自测脚本并赋权：chmod +x scripts/ci/gate-selftest.sh"
            exit 1
          fi

          mkdir -p artifacts/ci/gate-selftest
          scripts/ci/gate-selftest.sh artifacts/ci/gate-selftest

      - name: Run project CI gate scripts when business code changed
        shell: bash
        run: |
          set -euo pipefail

          if ! grep -E "^(modules|apps|services|src)/" changed_files.txt >/dev/null; then
            echo "本次未触发业务代码目录变更，跳过 lint/test/build/typecheck/coverage 门禁脚本。"
            exit 0
          fi

          required_scripts=(
            "scripts/ci/lint.sh"
            "scripts/ci/typecheck.sh"
            "scripts/ci/test.sh"
            "scripts/ci/build.sh"
            "scripts/ci/coverage-check.sh"
          )

          for s in "${required_scripts[@]}"; do
            if [ ! -x "$s" ]; then
              echo "缺少可执行 CI 门禁脚本：$s"
              echo "请按 AGENTS.md 12.5 配置并提交（脚本内落实 lint/typecheck/test/build/coverage>=80%）。"
              echo "下一步：补齐并赋予可执行权限：chmod +x scripts/ci/lint.sh scripts/ci/typecheck.sh scripts/ci/test.sh scripts/ci/build.sh scripts/ci/coverage-check.sh"
              exit 1
            fi
          done

          scripts/ci/lint.sh
          scripts/ci/typecheck.sh
          scripts/ci/test.sh
          scripts/ci/build.sh
          scripts/ci/coverage-check.sh
