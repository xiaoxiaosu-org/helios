#!/usr/bin/env bash
set -euo pipefail

log() {
  echo "[pre-push] $*"
}

root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "${root}" ]; then
  log "未检测到 git 仓库根目录，跳过。"
  exit 0
fi

cd "${root}"

headers_regex='^(功能:|功能与文件映射:|涉及文件:|主要改动:|为什么改:|验证:)$'

extract_section_from_file() {
  local file="$1"
  local header="$2"
  awk -v header="${header}" -v headers_regex="${headers_regex}" '
    $0 == header {
      in_section = 1
      next
    }
    $0 ~ headers_regex {
      if (in_section) {
        exit
      }
    }
    in_section {
      print
    }
  ' "${file}"
}

clean_section_from_file() {
  local file="$1"
  local header="$2"
  extract_section_from_file "${file}" "${header}" \
    | sed 's/\r$//' \
    | grep -vE '^[[:space:]]*(<!--.*-->)?[[:space:]]*$' || true
}

print_commit_detail() {
  local sha="$1"
  local short_sha
  local subject
  local body_file
  short_sha="$(git rev-parse --short "${sha}")"
  subject="$(git show -s --format=%s "${sha}" | tr -d '\r')"
  body_file="$(mktemp)"
  git show -s --format=%B "${sha}" > "${body_file}"

  log "-----"
  log "提交: [${short_sha}] ${subject}"

  for header in "功能:" "功能与文件映射:" "涉及文件:" "为什么改:" "验证:"; do
    section_content="$(clean_section_from_file "${body_file}" "${header}")"
    if [ -n "${section_content}" ]; then
      log "${header}"
      printf '%s\n' "${section_content}" | sed 's/^/[pre-push]   /'
    fi
  done

  rm -f "${body_file}"
}

branch="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
if [ -n "${branch}" ]; then
  if [ "${branch}" = "main" ] && [ "${HELIOS_ALLOW_PUSH_MAIN:-0}" != "1" ]; then
    log "禁止从 main 分支执行 push。请创建分支并走 PR。"
    log "如确需破例（不推荐），可临时设置：HELIOS_ALLOW_PUSH_MAIN=1"
    exit 1
  fi
fi

if [ "${HELIOS_ALLOW_PUSH_MAIN:-0}" != "1" ]; then
  while read -r local_ref local_sha remote_ref remote_sha; do
    [ -n "${remote_ref:-}" ] || continue
    if [ "${remote_ref}" = "refs/heads/main" ]; then
      log "禁止直接更新远端 main（检测到 push 目标为 refs/heads/main）。请走 PR 合并。"
      log "如确需破例（不推荐），可临时设置：HELIOS_ALLOW_PUSH_MAIN=1"
      exit 1
    fi
  done
fi

upstream_ref="$(git rev-parse --abbrev-ref --symbolic-full-name @{upstream} 2>/dev/null || true)"
commit_range=""
diff_range=""
if [ -n "${upstream_ref}" ]; then
  commit_range="${upstream_ref}..HEAD"
  diff_range="${upstream_ref}...HEAD"
elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
  commit_range="HEAD~1..HEAD"
  diff_range="HEAD~1...HEAD"
fi

if [ -n "${commit_range}" ]; then
  log "待推送提交摘要（${commit_range}）："
  git log --oneline --decorate "${commit_range}" || true

  commit_list="$(git rev-list --no-merges --reverse "${commit_range}" || true)"
  if [ -n "${commit_list}" ]; then
    log "待推送提交结构化明细："
    while IFS= read -r sha; do
      [ -n "${sha}" ] || continue
      print_commit_detail "${sha}"
    done <<< "${commit_list}"
  else
    log "待推送提交结构化明细：无新增非 merge 提交。"
  fi

  log "待推送文件摘要（${diff_range}）："
  git diff --name-status "${diff_range}" || true
else
  log "待推送摘要：无法确定比较范围（可能为首次提交或无上游分支）。"
fi

if [ -x scripts/docs/index-check.sh ]; then
  log "运行：scripts/docs/index-check.sh"
  scripts/docs/index-check.sh
else
  log "缺少 scripts/docs/index-check.sh（或不可执行），跳过。"
fi

if [ -x scripts/docs/rule-files-check.sh ]; then
  log "运行：scripts/docs/rule-files-check.sh（待推送提交范围校验）"
  tmp_changed="$(mktemp)"
  upstream_ref="$(git rev-parse --abbrev-ref --symbolic-full-name @{upstream} 2>/dev/null || true)"
  if [ -n "${upstream_ref}" ]; then
    git diff --name-only "${upstream_ref}...HEAD" > "${tmp_changed}"
  else
    git diff --name-only HEAD~1..HEAD > "${tmp_changed}" || true
  fi
  scripts/docs/rule-files-check.sh "${tmp_changed}"
  rm -f "${tmp_changed}"
else
  log "缺少 scripts/docs/rule-files-check.sh（或不可执行），跳过。"
fi

if [ -x scripts/ci/verify.sh ]; then
  log "运行：scripts/ci/verify.sh"
  scripts/ci/verify.sh
else
  log "缺少 scripts/ci/verify.sh（或不可执行），跳过。"
fi
if [ -n "${branch}" ]; then
  if echo "${branch}" | grep -Eq 'CAP-[0-9]{3}'; then
    cap_id="$(echo "${branch}" | grep -Eo 'CAP-[0-9]{3}' | head -n1)"
    if [ -x "scripts/cap/verify.sh" ]; then
      log "检测到分支包含 ${cap_id}，运行：scripts/cap/verify.sh ${cap_id}"
      scripts/cap/verify.sh "${cap_id}"
    else
      log "缺少 scripts/cap/verify.sh（或不可执行），跳过 CAP 验收。"
    fi
  else
    log "分支不包含 CAP-00X，跳过 CAP 验收：${branch}"
  fi
else
  log "未检测到当前分支（可能是 detached HEAD），跳过 CAP 验收。"
fi
