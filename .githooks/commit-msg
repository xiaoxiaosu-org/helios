#!/usr/bin/env bash
set -euo pipefail

log() {
  echo "[commit-msg] $*"
}

msg_file="${1:-}"
if [ -z "${msg_file}" ] || [ ! -f "${msg_file}" ]; then
  log "未提供 commit message 文件，跳过。"
  exit 0
fi

if [ "${HELIOS_ALLOW_RELAXED_COMMIT_MSG:-0}" = "1" ]; then
  log "检测到 HELIOS_ALLOW_RELAXED_COMMIT_MSG=1，跳过校验。"
  exit 0
fi

allow_non_zh=0
if [ "${HELIOS_ALLOW_NON_ZH_COMMIT_MSG:-0}" = "1" ]; then
  allow_non_zh=1
  log "检测到 HELIOS_ALLOW_NON_ZH_COMMIT_MSG=1，放宽中文提交校验。"
fi

subject="$(sed -n '1p' "${msg_file}" | tr -d '\r')"

if echo "${subject}" | grep -Eq '^(Merge |fixup!|squash!|Revert ")'; then
  log "检测到特殊提交（merge/fixup/squash/revert），跳过模板校验。"
  exit 0
fi

subject_regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([[:alnum:]./_-]+\))?!?: .{1,72}$'
if ! echo "${subject}" | grep -Eq "${subject_regex}"; then
  log "提交标题不符合规范：${subject}"
  log "期望：type(scope): summary"
  log "类型：feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
  exit 1
fi

if echo "${subject}" | grep -Eq '<(scope|summary)>'; then
  log "提交标题仍包含模板占位符，请填写后再提交。"
  exit 1
fi

if [ "${allow_non_zh}" -ne 1 ]; then
  if ! echo "${subject}" | grep -P -q '[\x{4e00}-\x{9fff}]'; then
    log "提交标题默认应使用中文（可保留必要英文术语）。"
    log "如确需本次放宽，可临时设置：HELIOS_ALLOW_NON_ZH_COMMIT_MSG=1"
    exit 1
  fi
fi

required_headers=(
  "功能:"
  "功能与文件映射:"
  "涉及文件:"
  "主要改动:"
  "为什么改:"
  "验证:"
)

headers_regex='^(功能:|功能与文件映射:|涉及文件:|主要改动:|为什么改:|验证:)$'

extract_section() {
  local header="$1"
  awk -v header="${header}" -v headers_regex="${headers_regex}" '
    $0 == header {
      in_section = 1
      next
    }
    $0 ~ headers_regex {
      if (in_section) {
        exit
      }
    }
    in_section {
      print
    }
  ' "${msg_file}"
}

clean_section() {
  local header="$1"
  extract_section "${header}" \
    | sed 's/\r$//' \
    | grep -vE '^[[:space:]]*(<!--.*-->)?[[:space:]]*$' || true
}

for header in "${required_headers[@]}"; do
  if ! grep -Eq "^${header}$" "${msg_file}"; then
    log "提交正文缺少必填段落：${header}"
    log "请使用 .github/commit_message_template.md 作为提交模板。"
    exit 1
  fi

  section_content="$(clean_section "${header}")"
  if [ -z "${section_content}" ]; then
    log "提交正文段落为空：${header}"
    exit 1
  fi

  if echo "${section_content}" | grep -Eq '<[^>]+>'; then
    log "提交正文段落仍包含占位符：${header}"
    exit 1
  fi
done

feature_mapping="$(clean_section "功能与文件映射:")"
if ! echo "${feature_mapping}" | grep -Eq '^[[:space:]]*-[[:space:]]*[^:]+:[[:space:]]*.+$'; then
  log "“功能与文件映射:”段落格式不正确，需使用：- 功能: 文件列表"
  exit 1
fi

if [ "${allow_non_zh}" -ne 1 ]; then
  for zh_header in "功能:" "主要改动:" "为什么改:"; do
    zh_content="$(clean_section "${zh_header}")"
    if ! echo "${zh_content}" | grep -P -q '[\x{4e00}-\x{9fff}]'; then
      log "段落默认应包含中文描述：${zh_header}"
      log "如确需本次放宽，可临时设置：HELIOS_ALLOW_NON_ZH_COMMIT_MSG=1"
      exit 1
    fi
  done
fi

print_section() {
  local header="$1"
  local section_content
  section_content="$(clean_section "${header}")"
  log "${header}"
  printf '%s\n' "${section_content}" | sed 's/^/[commit-msg]   /'
}

log "结构化提交明细："
log "标题: ${subject}"
print_section "功能:"
print_section "功能与文件映射:"
print_section "涉及文件:"
print_section "为什么改:"
print_section "验证:"
log "暂存文件变更："
git diff --cached --name-status | sed 's/^/[commit-msg]   /' || true
