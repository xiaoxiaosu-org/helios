# CAP-004 架构依赖门禁落地经验

> 版本：v1.0
> 最近更新：2026-02-28
> 适用范围：需要在 CI 中落地“目录边界/依赖方向”硬门禁的仓库
> 对应实现：`scripts/ci/arch-check.sh`、`scripts/ci/verify.sh`、`.github/workflows/quality-gates.yml`

## 1. 背景

CAP-004 的目标是把“架构边界约定”升级为可执行、可阻断、可追溯的门禁。

本次落地采用轻量脚本先行：
- 规则来源文档：`docs/02-架构/边界与依赖规则.md`
- 执行脚本：`scripts/ci/arch-check.sh`
- 接入链路：本地 `scripts/ci/verify.sh` + CI `quality-gates.yml`

## 2. 实施步骤（可复用）

1. 先定义可读规则：明确层级与允许依赖矩阵。
2. 再做脚本校验：扫描 import/require/from 语句并映射目录层级。
3. 最后接入门禁：本地聚合入口与 CI 同时启用，避免绕过。
4. 验收闭环：执行 `scripts/cap/verify.sh CAP-004`，产出 `artifacts/` 证据。

## 3. 本次踩坑与修复

### 3.1 Git 门禁文档联动

- 现象：修改 `quality-gates.yml` 后，`doc-check` 报“未更新唯一信息源文档”。
- 原因：触发了 Git 门禁实现变更，必须同步更新 `docs/02-架构/工程治理/Git门禁与模板对照清单.md`。
- 修复：在对照矩阵补充“架构依赖方向门禁（CAP-004）”条目。

### 3.2 经验库豁免日期口径

- 现象：PR 填了经验库豁免，但日期超出 `T+1` 被阻断。
- 原因：CI 以 UTC 日期校验，补齐截止日期只能是“今天或明天”。
- 修复：修正 PR 日期，并最终补齐本经验文档，取消未补齐状态。

### 3.3 PR 描述渲染对脚本影响

- 现象：`doc-check` 中解析 PR 描述时出现命令执行噪音。
- 原因：工作流把 PR body 直接嵌入 shell 字符串，描述内特殊符号可能被解释。
- 修复：PR 描述尽量使用纯文本，避免在易触发片段中使用特殊 shell 元字符。

## 4. 建议模板（后续项目复用）

1. 新门禁能力上线前，先补“规则文档 + 对照清单”。
2. 工作流改动 PR 默认同时更新经验库，减少豁免依赖。
3. PR 模板中的“经验库豁免”仅作为应急兜底，不作为常态流程。

## 5. 验证命令

```bash
scripts/cap/verify.sh CAP-004
scripts/ci/verify.sh
scripts/docs/git-governance-sync-check.sh
```
