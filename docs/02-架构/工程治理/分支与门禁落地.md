# 分支与门禁落地（流程版）

本文只回答“怎么落地执行”：
- 如何配置主干保护
- 日常分支如何推进到 PR 合并
- 何时运行本地与 CI 门禁

不承载 hook/workflow/template 细项规则。

唯一信息源：
- Git 门禁、模板字段、临时放宽变量、脚本执行链路，请以  
  `docs/02-架构/工程治理/Git门禁与模板对照清单.md` 为准。

---

## 1) 主干保护（必须）

核心目标：允许 feature 分支自由推进，禁止不合格变更进入 `main`。

推荐配置（GitHub Rulesets / Branch protection）：
- Require a pull request before merging
- Require status checks to pass（必须包含 `quality-gates`、`checks`）
- Require branches to be up to date before merging
- Block force pushes
- 建议只允许 `Squash` 或 `Rebase`（避免 merge commit）

结论：
- `git push` 只会触发检查，不会直接阻止你推分支
- “阻止进入主干”依赖主干保护 + required checks

---

## 2) 日常分支流程（feature -> PR -> merge）

1) 接到需求先确认分支
- `git rev-parse --abbrev-ref HEAD`
- 若在 `main`：先创建工作分支，再开始任何文件改动（建议 `cap/CAP-00X-<topic>` 或 `feat/<topic>`）

2) 从主干创建分支
- `git checkout main`
- `git pull --rebase`
- `git checkout -b feat/<topic>`（或 `cap/CAP-00X-<topic>`）

3) 开发与本地验证
- 按需运行：`scripts/ci/verify.sh`
- CAP 场景额外运行：`scripts/cap/verify.sh CAP-00X`
- 若 CAP 验收返回 `0`：立即进入提交/推送/PR，不得仅停留在“本地通过”

4) 提交与推送
- 按提交模板完成结构化提交信息
- 先在协作会话打印“提交结构化明细”（用户可见）
- 推送前在协作会话输出“本次改动摘要”（提交列表 + 文件列表）并确认

5) 创建 PR（base=`main`）
- 按 PR 模板填写结构化描述
- 若命中高风险 Git 门禁变更且本次未更新经验库：必须填写“经验库豁免说明 + 补齐截止日期（YYYY-MM-DD，<=T+1日）”
- 在协作会话同步打印 PR 结构化明细与关键链接（用户可见）
- 等待 `quality-gates`、`checks` 通过

6) 合并与清理
- 通过 Review 后合并
- 删除分支

---

## 3) 本地门禁接入（执行入口）

- 安装入口：`scripts/dev/install-git-hooks.sh`
- 运行效果：启用 `.githooks/` 与提交模板
- 具体 hook 行为与例外变量：见唯一信息源文档（对照清单）

---

## 4) CI 门禁接入（执行入口）

- 门禁实现：
  - `.github/workflows/doc-check.yml`
  - `.github/workflows/quality-gates.yml`
  - `.github/workflows/governance-auto-sync.yml`（定时治理基线升级）
- 具体校验项与模板字段要求：见唯一信息源文档（对照清单）

---

## 5) 变更治理约束（防重复）

当你修改以下任一项时，必须同步更新唯一信息源文档：
- `.githooks/*`
- `.github/workflows/*`
- `.github/commit_message_template.md`
- `.github/pull_request_template.md`
- `scripts/dev/install-git-hooks.sh`

禁止在本文重复维护细项清单（避免双份规则漂移）。
