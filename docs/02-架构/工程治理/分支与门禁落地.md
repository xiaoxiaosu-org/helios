# 分支与门禁落地（让 CI 真正阻止“不合格合并”）

本仓库的门禁（Workflows、脚本、模板）要“真正起作用”，关键在于 **保护主干分支**：允许推送 feature 分支，但禁止绕过 PR 直接把不合格变更进入主干。

结论：
- `git push` 不会被 CI 直接拦住（它只会触发 CI 产出状态）。
- **分支保护（Branch protection）** 才是“阻止合并”的开关：未通过门禁的变更无法进入受保护分支（通常是 `main`）。
- 为减少“推上去才发现失败”，可选启用本地 `pre-push` hook 自动跑一次关键门禁。

---

## 1) GitHub 必配：保护主干（必须）

在 GitHub 仓库中配置（Settings → Branches → Branch protection rules）：

### 1.1 保护 `main`（或你的默认主干）

建议规则（推荐最小集）：
- Require a pull request before merging（必须走 PR）
- Require approvals（至少 1 个审批）
- Require review from Code Owners（启用 CODEOWNERS 强制审批）
- Require conversation resolution（必须解决对话）
- Require status checks to pass before merging（必须通过状态检查）
  - 勾选以下 checks（名称以 GitHub UI 实际显示为准；通常为“工作流名 / job 名”）：
    - `Quality Gates / quality-gates`（工作流 `.github/workflows/quality-gates.yml`，job=`quality-gates`）
    - `Documentation & Architecture Checks / checks`（工作流 `.github/workflows/doc-check.yml`，job=`checks`）
- Require branches to be up to date before merging（合并前必须更新到最新主干）
- (可选) Require linear history（线性历史；配合 rebase/squash）
- (可选) Include administrators（管理员也必须遵守）
- (强烈建议) Restrict who can push to matching branches（限制谁能直推主干）

这样配置后：
- 你依然可以随意 `git push` 到 feature 分支；
- 但 **未通过门禁的变更无法合并进主干**。

---

## 2) 推荐分支管理流程（日常）

### 2.1 分支命名

建议约定：
- CAP 推进分支：`cap/CAP-00X-<topic>`
- 常规功能：`feat/<topic>`
- 修复：`fix/<topic>`
- 紧急修复：`hotfix/<topic>`（见治理细则的 Hotfix 例外流程）

### 2.2 日常流程（feature → PR → merge）

1) 从主干拉新分支
- `git checkout main`
- `git pull --rebase`
- `git checkout -b cap/CAP-009-pr-template`

2) 按“每个 PR 只推进一个 CAP”的原则实现最小变更

3) 本地跑一次门禁（推荐）
- `scripts/cap/verify.sh CAP-00X`
- 如涉及业务代码目录（`modules/`、`apps/`、`services/`、`src/`）：`scripts/ci/verify.sh`

4) 推送分支并创建 PR（base = `main`）

5) 等待 CI 通过 + Owner Review 通过

6) 合并策略（建议二选一）
- Squash merge：更干净的主干历史（推荐）
- Rebase merge：要求线性历史时使用

7) 合并后删除分支

---

## 3) 可选增强：本地 pre-push hook（减少“推上去才失败”）

本地 hook 的定位：**提前失败**，节省 CI 循环时间；它不是安全边界，安全边界仍由受保护分支 + 必过 checks 保证。

启用方式：
- 执行：`scripts/dev/install-git-hooks.sh`

启用后，在 `git push` 前会自动运行：
- `scripts/docs/index-check.sh`
- `scripts/ci/verify.sh`
- 若当前分支名包含 `CAP-00X`，则额外运行：`scripts/cap/verify.sh CAP-00X`

临时跳过（仅紧急场景；需在 PR 说明原因）：
- `git push --no-verify`
