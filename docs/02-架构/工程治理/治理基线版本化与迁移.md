# 治理基线版本化与迁移

本文定义如何把工程治理能力从“项目内约定”升级为“可迁移产品”。

## 目标

- 不依赖人工提醒维持治理更新。
- 通过 `governance.lock` 固化版本与来源。
- 支持在其他仓库一键同步治理基线。
- 通过定时任务自动发现上游更新并发起升级 PR。

## 核心资产

- 锁文件：`governance.lock`
- 清单：`governance/baseline/manifest.txt`
- 版本：`governance/baseline/VERSION`
- 同步脚本：`scripts/governance/sync-baseline.sh`
- 锁校验脚本：`scripts/governance/enforce-lock.sh`
- 上游检测脚本：`scripts/governance/check-release.sh`
- CI 门禁：`scripts/ci/governance-lock-check.sh`
- 自动升级 workflow：`.github/workflows/governance-auto-sync.yml`

当前基线（`v0.2.0`）新增：
- `scripts/ci/plan-template-check.sh`（计划模板一致性门禁）
- `scripts/workflow/backlog.sh check`（WorkItem 主文件新鲜度门禁）
- WorkItem 事件追踪（`artifacts/workflow/events/*.jsonl`）

## 锁文件字段

`governance.lock` 使用 `KEY=VALUE` 形式：

- `GOVERNANCE_ROLE`: `source` 或 `consumer`
- `GOVERNANCE_BASELINE_VERSION`: 基线版本
- `GOVERNANCE_SOURCE_REPO`: 上游治理仓库
- `GOVERNANCE_SOURCE_REF`: 上游分支/标签/提交
- `GOVERNANCE_SOURCE_COMMIT`: 当前锁定提交
- `GOVERNANCE_MANIFEST`: 受管文件清单路径
- `GOVERNANCE_LAST_SYNCED_AT`: 最近同步时间（UTC）

角色约定：
- `source`：治理模板源仓库，仅校验结构，不做远端漂移对比。
- `consumer`：治理消费仓库，CI 强制执行漂移检查。

## 一键迁移（推荐）

在目标仓库执行：

```bash
scripts/governance/sync-baseline.sh \
  --target . \
  --source-repo git@github.com:su-xiaoxiao/helios.git \
  --source-ref main \
  --role consumer \
  --force
```

然后安装 hook 与本地验证：

```bash
scripts/dev/install-git-hooks.sh
scripts/ci/verify.sh
```

## 持续升级

自动升级流程：

1. 定时任务执行 `scripts/governance/check-release.sh`。
2. 若检测到上游提交变化，执行 `scripts/governance/sync-baseline.sh --force`。
3. 自动创建升级 PR，进入常规门禁与审查。

## 稳定维护原则

- 受管文件必须只通过清单维护，避免“口头同步”。
- 规则变更必须更新：实现 + 对照清单 + 经验文档。
- 任何例外（豁免、临时放宽）必须有时效与补齐动作。
