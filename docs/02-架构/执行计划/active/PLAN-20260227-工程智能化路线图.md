# PLAN-20260227：工程智能化路线图（可追踪能力清单）

本计划对标 “Harness engineering” 描述的工程智能化能力，将能力拆解为可执行、可验证、可演进的交付项。

## 范围与原则

- 目标：让智能体不仅“理解规则”，还能“运行命令完成任务并自证结果”。
- 原则：能机械化的要求必须进入脚本/CI；文档只保留入口导航与系统记录（system of record）。
- 系统记录入口：
  - 入口导航：`AGENTS.md`
  - 文档导航：`docs/README.md`
  - 工程治理细则：`docs/02-架构/工程治理/工程治理与门禁.md`

## 自举闭环（Bootstrap Loop）

为了避免上下文膨胀与“多目标并行导致不可验证”，每次只推进一个 CAP，并形成可机械验证的闭环证据。

约束：
- 每个 PR 只能推进一个 CAP（例如：只做 CAP-004 的实现与验证资产，不顺手“顺便重构”其他能力）
- CAP 的 DoD 必须能通过命令验证，且必须产出证据到 `artifacts/`（目录规范见 `docs/07-运行态/产物与证据目录规范.md`）

标准流程（每次一轮）：
1) 选定 CAP：确定本次只推进 `CAP-00X`
2) 建立验收命令：确保该 CAP 的 Acceptance Commands 已存在且可执行（缺失则先补脚本骨架）
3) 先跑一次验收命令：获得基线结果与证据（通常为失败或 blocked）
4) 实现能力：最小变更完成该 CAP 的交付物
5) 再跑验收命令：必须返回码 `0`，并产出完整证据产物
6) 固化系统记录：更新对应 `docs/`（必要时新增 ADR），并把“如何验证”写进索引/计划（而不是写在聊天里）

## 能力缺口清单（Roadmap）

状态枚举：`Planned` / `In Progress` / `Blocked` / `Done`

| ID | 能力 | 当前缺口（摘要） | 交付物（可执行/可验证） | 门禁/验收（DoD） | 状态 |
|---|---|---|---|---|---|
| CAP-001 | 可运行的任务沙盒（每任务隔离） | 缺少按任务创建隔离运行环境的规范与脚本 | `scripts/dev/sandbox-create.sh`（或等价）+ 文档说明放 `docs/07-运行态/` | CI 可选；本地脚本可重复运行并能清理 | Planned |
| CAP-002 | Agent 驱动的 UI 验证（浏览器自动化） | 缺少可脚本化的 UI 验证入口与产物归档 | `scripts/e2e/run-ui-check.sh` 产出截图/录屏到固定目录 | 失败时产物可用于复盘；成功可复现 | Planned |
| CAP-003 | 可查询的可观测性闭环（logs/metrics/traces） | 缺少统一日志字段、采集/查询入口与最小仪表盘/查询剧本 | `docs/07-运行态/` 新增“查询剧本”+ 示例查询 + 最小字段规范 | 任意关键链路能按 `traceId` 追到结果与耗时 | Planned |
| CAP-004 | 架构边界/依赖方向的结构化约束（taste invariants） | 缺少可机械校验的“目录/模块依赖规则” | `scripts/ci/arch-check.sh` + 规则文件（例如 `docs/02-架构/边界与依赖规则.md`） | CI 硬门禁：违规则阻断且报错提供修复指令 | Done |
| CAP-005 | 结构化日志规范自动校验 | 目前只禁止 debug print，缺少结构化字段一致性校验 | `scripts/ci/logging-check.sh`（按语言栈逐步启用） | CI 报错必须指向“应该使用的 logger/字段” | Planned |
| CAP-006 | 质量评分与预算（QUALITY_SCORE / 可靠性预算） | 缺少可持续更新的质量维度与评分记录 | `docs/02-架构/质量评分与演进.md`（评分维度+目标+现状） | 每个里程碑更新一次评分与差距 | Planned |
| CAP-007 | 技术债追踪（tech debt tracker） | 缺少统一技术债清单与偿还机制 | `docs/02-架构/技术债清单.md`（带 ID/优先级/验收） | 每次计划评审更新状态；完成项移入 completed | Done |
| CAP-008 | Doc-gardening（周期性熵控制） | 缺少定期扫描断链/过期/索引缺失并提 PR 的机制 | GitHub scheduled workflow + `scripts/docs/gardening.sh` | 每周自动出报告或 PR；可快速审阅合并 | Planned |
| CAP-009 | PR 闭环自动化（从失败到修复指路） | 缺少 PR 模板、失败指路一致性、修复剧本入口 | `.github/pull_request_template.md` + CI 报错信息标准化 | PR 默认携带 DoD；失败信息带下一步命令 | Done |
| CAP-010 | PR 校验鲁棒性（门禁自测 + push diff 回退） | 门禁存在“脚本可执行但规则失效”与 force-push 后 push 检查误失败风险 | `scripts/ci/gate-selftest.sh` + workflow diff fallback（`doc-check`/`quality-gates`） | CI 强制执行门禁自测；before SHA 不可达时仍可完成校验 | Done |

## 验收命令与证据产物（Acceptance Commands & Artifacts）

通用约定：
- 所有 CAP 的验收都必须可通过命令机械验证
- 统一验收入口：`scripts/cap/verify.sh <CAP-ID>`
  - 成功返回码：`0`
  - 失败返回码：`1`（断言不满足）
  - 阻塞返回码：`2`（缺少前置条件/未配置/未实现）
  - 脚本内部错误：`3`
- 统一证据目录：`artifacts/<CAP-ID>/<run-id>/...`
  - `run-id` 由验收命令生成，且在 `meta.json` 中可追溯（包括 git sha、命令、退出码）
  - 证据目录规范见：`docs/07-运行态/产物与证据目录规范.md`

### CAP-001：可运行的任务沙盒（每任务隔离）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-001`
- DoD（机械可验）：
  - `scripts/dev/sandbox-create.sh` 与 `scripts/dev/sandbox-destroy.sh` 存在且可执行
  - `scripts/dev/sandbox-create.sh --smoke --out "$ARTIFACT_DIR"` 返回码 `0`
  - `scripts/dev/sandbox-destroy.sh --smoke --out "$ARTIFACT_DIR"` 返回码 `0`
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-001/<run-id>/meta.json`
  - `artifacts/CAP-001/<run-id>/run.log`
  - `artifacts/CAP-001/<run-id>/sandbox.env`（用于后续步骤接力的环境信息）
  - `artifacts/CAP-001/<run-id>/cleanup.log`

### CAP-002：Agent 驱动的 UI 验证（浏览器自动化）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-002`
- DoD（机械可验）：
  - `scripts/e2e/run-ui-check.sh --headless --out "$ARTIFACT_DIR"` 返回码 `0`
  - 若失败（返回码非 0），仍必须产出可复盘证据（截图/录屏/控制台日志）
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-002/<run-id>/meta.json`
  - `artifacts/CAP-002/<run-id>/run.log`
  - `artifacts/CAP-002/<run-id>/screenshots/`（至少 1 张）
  - `artifacts/CAP-002/<run-id>/video/`（可选，但失败时建议提供）
  - `artifacts/CAP-002/<run-id>/browser-console.log`

### CAP-003：可查询的可观测性闭环（logs/metrics/traces）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-003`
- DoD（机械可验）：
  - 存在可运行的查询命令：`scripts/obs/query-trace.sh <traceId> --out "$ARTIFACT_DIR"`（或等价）
  - `scripts/obs/smoke-trace.sh --out "$ARTIFACT_DIR"` 返回码 `0` 并产出 1 个可查询 `traceId`
  - 通过 `query-trace.sh` 能输出链路关键字段（至少 `traceId`、`result`、`durationMs`）
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-003/<run-id>/meta.json`
  - `artifacts/CAP-003/<run-id>/run.log`
  - `artifacts/CAP-003/<run-id>/traceId.txt`
  - `artifacts/CAP-003/<run-id>/trace.json`（或 `.txt`，包含查询结果）

### CAP-004：架构边界/依赖方向的结构化约束（taste invariants）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-004`
  - （底层门禁）`scripts/ci/arch-check.sh`
- DoD（机械可验）：
  - `scripts/ci/arch-check.sh --out "$ARTIFACT_DIR"` 返回码 `0`
  - 违规则必须返回码非 0，且报错信息包含“下一步修复指令”（命令/文件位置）
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-004/<run-id>/meta.json`
  - `artifacts/CAP-004/<run-id>/run.log`
  - `artifacts/CAP-004/<run-id>/arch-check-report.json`（或 `.txt`）

### CAP-005：结构化日志规范自动校验

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-005`
  - （底层门禁）`scripts/ci/logging-check.sh`
- DoD（机械可验）：
  - `scripts/ci/logging-check.sh --out "$ARTIFACT_DIR"` 返回码 `0`
  - 违规则必须返回码非 0，并指向“应使用的 logger/字段”
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-005/<run-id>/meta.json`
  - `artifacts/CAP-005/<run-id>/run.log`
  - `artifacts/CAP-005/<run-id>/logging-check-report.json`（或 `.txt`）

### CAP-006：质量评分与预算（QUALITY_SCORE / 可靠性预算）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-006`
- DoD（机械可验）：
  - `docs/02-架构/质量评分与演进.md` 存在
  - 文件包含维度、现状、下一步三类信息（通过脚本检查）
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-006/<run-id>/meta.json`
  - `artifacts/CAP-006/<run-id>/run.log`
  - `artifacts/CAP-006/<run-id>/quality-score-check.txt`

### CAP-007：技术债追踪（tech debt tracker）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-007`
- DoD（机械可验）：
  - `docs/02-架构/技术债清单.md` 存在
  - 至少包含 1 条 `TD-` 记录（通过脚本检查）
  - 必须包含关键字段列：`最近更新`、`验收标准`（通过脚本检查，且不得含 `Owner`）
  - 每条 `TD-` 记录必须包含合法状态：`Open|In Progress|Blocked|Done`（通过脚本检查）
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-007/<run-id>/meta.json`
  - `artifacts/CAP-007/<run-id>/run.log`
  - `artifacts/CAP-007/<run-id>/tech-debt-check.txt`

### CAP-008：Doc-gardening（周期性熵控制）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-008`
- DoD（机械可验）：
  - `scripts/docs/gardening.sh --out "$ARTIFACT_DIR"` 返回码 `0`
  - 存在定时 workflow（例如 `.github/workflows/doc-gardening.yml`）且包含 `schedule`
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-008/<run-id>/meta.json`
  - `artifacts/CAP-008/<run-id>/run.log`
  - `artifacts/CAP-008/<run-id>/report.md`（扫描结果，允许为空但必须存在）

### CAP-009：PR 闭环自动化（从失败到修复指路）

- Acceptance Commands：
  - `scripts/cap/verify.sh CAP-009`
- DoD（机械可验）：
  - 存在 PR 模板：`.github/pull_request_template.md`（或 `.github/PULL_REQUEST_TEMPLATE.md`）
  - PR 模板包含 DoD 勾选项（至少覆盖 docs/ADR/测试/trace/安全）
  - 关键 CI 门禁失败信息包含“下一步命令/文件路径”（通过脚本静态检查）
- Evidence Artifacts（必须产出）：
  - `artifacts/CAP-009/<run-id>/meta.json`
  - `artifacts/CAP-009/<run-id>/run.log`
  - `artifacts/CAP-009/<run-id>/pr-template-check.txt`
  - `artifacts/CAP-009/<run-id>/ci-guidance-check.txt`

### CAP-010：PR 校验鲁棒性（门禁自测 + push diff 回退）

- Acceptance Commands：
  - `scripts/ci/gate-selftest.sh`
  - `scripts/ci/verify.sh`
- DoD（机械可验）：
  - `scripts/ci/gate-selftest.sh` 存在且可执行，返回码 `0`
  - `quality-gates.yml` 执行 `gate-selftest` 步骤并在失败时阻断
  - `doc-check.yml` 与 `quality-gates.yml` 在 push 事件使用 `before SHA` 不可达回退逻辑（merge-base 或等价兜底）
- Evidence Artifacts（必须产出）：
  - `artifacts/ci/gate-selftest/gate-selftest-report.txt`

## 里程碑（建议）

- M1（先让 agent “能跑起来”）：CAP-004、CAP-007、CAP-009
- M2（让 agent “能自证结果”）：CAP-003、CAP-006
- M3（让系统 “能自我除草”）：CAP-008
- M4（让 agent “能做端到端验证”）：CAP-001、CAP-002

## 风险与依赖

- CAP-001/002/003 通常依赖实际业务模块与可运行服务；在业务代码落地前先建立接口与占位规范，不强行做“空跑”。
- CAP-004/005 可先按目录约束起步（`modules/`、`apps/`、`services/`、`src/`），再随实际模块细化。
