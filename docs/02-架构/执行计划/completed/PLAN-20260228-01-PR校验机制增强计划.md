# PLAN-20260228-01：PR 校验机制增强计划（防遗忘版）

> 归档说明：该计划已转入 `completed/`，不再作为执行主计划维护，相关执行项已并入 `PLAN-20260227-01` 的 `WI-PLAN*` 体系。

## 背景与目标

- 背景：曾出现“CI 绿但关键规则失效”的情况，暴露出门禁稳定性与回归机制不足。
- 目标：把 PR 校验改造成可回归、可追踪、可演进的治理能力。
- 非目标：本计划不替代业务功能计划，只覆盖 PR 校验与治理链路。

## WorkItem 清单

| WorkItem | legacy 别名 | 类型 | 标题 | Owner | 状态 | 验收命令 | 证据目录 |
|---|---|---|---|---|---|---|---|
| WI-CAP-009 | CAP-009 | capability | PR 闭环自动化 | repo-owner | done | `scripts/cap/verify.sh CAP-009` | `artifacts/CAP-009/` |
| WI-CAP-010 | CAP-010 | capability | PR 校验鲁棒性增强 | repo-owner | done | `scripts/cap/verify.sh CAP-010` | `artifacts/CAP-010/` |
| WI-TD-001 | TD-001 | debt | 工程智能化能力缺口落地（PR 相关子域） | repo-owner | in_progress | `scripts/workflow/run.sh TD-001 progress` | `artifacts/workflow/` |

## 推进记录

| 日期 | WorkItem | 动作 | 结果 | 备注 |
|---|---|---|---|---|
| 2026-02-28 | WI-CAP-010 | `scripts/ci/gate-selftest.sh` | pass | 补齐正反例自测 |
| 2026-02-28 | WI-CAP-010 | push diff 回退增强 | pass | before SHA 不可达时回退 merge-base |
| 2026-02-28 | WI-CAP-009 | 模板与指路信息收敛 | pass | PR 模板与 CI 指路统一 |

## 验收与证据

- 核心验收命令：
  - `scripts/ci/gate-selftest.sh`
  - `scripts/docs/git-governance-sync-check.sh`
  - `scripts/ci/verify.sh`
- 关键证据：
  - `artifacts/ci/gate-selftest/gate-selftest-report.txt`
  - `artifacts/CAP-009/*`、`artifacts/CAP-010/*`

## 风险与阻塞

- 风险：后续新增 workflow 若未补回退逻辑，可能再次出现 push 场景误失败。
- 风险：门禁规则迭代速度快，若无统一模板和基线升级，跨仓库易漂移。
- 阻塞：暂无。

## 下一步

1. 把计划模板统一到 `docs/02-架构/执行计划/PLAN-模板-WorkItem.md`。
2. 将 PR 校验相关 WorkItem 纳入统一 backlog 事件追踪。
3. 在多仓库场景通过治理基线自动升级保持规则一致。

## 分阶段计划（历史记录）

| 阶段 | 目标 | 交付物 | 验收命令 | 状态 |
|---|---|---|---|---|
| P1 | 门禁自测落地 | `scripts/ci/gate-selftest.sh` + `scripts/ci/verify.sh` 接入 | `scripts/ci/gate-selftest.sh` | Done |
| P2 | CI 稳定性增强 | `doc-check.yml`/`quality-gates.yml` 增加 before SHA 不可达回退 | 触发 push 场景并观察 checks/quality-gates 通过 | Done |
| P3 | 治理与经验固化 | 对照清单、经验库、ADR、路线图同步更新 | `scripts/docs/git-governance-sync-check.sh` | Done |

## 持续动作（每次规则变更必须执行）

1. 新增/修改门禁脚本时，同步补 `gate-selftest` 正反例。
2. 任何使用 `github.event.before` 的 workflow 步骤，必须包含不可达回退逻辑。
3. PR 描述必须附验证命令与关键产物路径。
