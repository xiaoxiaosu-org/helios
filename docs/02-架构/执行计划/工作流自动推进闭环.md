# 工作流自动推进与闭环（TD/CAP）

本文定义技术债与执行计划的统一编排入口，目标是把“追踪-验证-推进-闭环”变成可执行流程，而非依赖会话记忆。

## 单一事实源

- 统一工作项主文件：`docs/02-架构/执行计划/backlog.yaml`
- 工作流映射：`docs/02-架构/执行计划/workflow-map.yaml`
- 技术债清单：`docs/02-架构/技术债清单.md`
- 路线图计划：`docs/02-架构/执行计划/active/PLAN-20260227-工程智能化路线图.md`
- ADR 索引：`docs/09-ADR-架构决策/ADR-索引.md`

语义约定（避免分类膨胀）：
- `WorkItem(kind=debt)`：技术债实体，`TD-XXX` 仅是其编号
- `WorkItem(kind=capability)`：能力建设实体，编号为 `CAP-XXX`
- debt/capability 关系通过 `links` 字段表达，不再把 TD 当成独立语义类别

`workflow-map.yaml` 维护以下信息：
- `TD -> CAP` 对应关系
- 触发路径（哪些改动会触发文档联动检查）
- 必需同步文档
- 验收命令列表（Acceptance Commands）
- 闭环检查要求

`close_checks` 推荐字段：
- `td_must_move_done`：是否强制 TD 条目迁移到“已完成”分区
- `cap_status_done`：是否强制 `cap_id` 在路线图中状态为 `Done`
- `adr_required`：是否强制 ADR 索引中存在该 `cap_id` 相关记录

## 命令入口

- 启动：`scripts/workflow/start.sh TD-001`
- 推进：`scripts/workflow/progress.sh TD-001`
- 闭环：`scripts/workflow/close.sh TD-001`
- 一键执行：`scripts/workflow/run.sh TD-001 full`
- 列出技术债：`scripts/workflow/td-list.sh [open|done|all]`
- 新增技术债：
  `scripts/workflow/td-add.sh --title "标题" --impact "影响面" --priority "P1" --acceptance "验收标准" --cap "CAP-011"`
- 统一入口：
  - `scripts/workflow/run.sh list all`
  - `scripts/workflow/run.sh add --title "标题" --impact "影响面" --priority "P1" --acceptance "验收标准" --cap "CAP-011"`
  - `scripts/workflow/run.sh backlog build`
  - `scripts/workflow/run.sh backlog check`
  - `scripts/workflow/run.sh overview json`
  - `scripts/workflow/run.sh overview serve 127.0.0.1 8787`

行为说明：
- `start`：在 `main` 自动创建工作分支、更新 TD 状态为 `In Progress`、生成 checklist。
- `progress`：按 map 顺序执行验收命令并产出报告。
- `close`：先重跑 `progress`，再做必需文档/闭环条件检查并产出闭环报告。
- `td-list`：按在制/完成范围列出 TD，便于选取下一项。
- `td-add`：同时写入技术债清单与 workflow-map，生成新的 `TD-XXX` 编号。
- `backlog build`：将现有执行源同步为统一 WorkItem 主文件 `backlog.yaml`（便于总览与管理）。
- `backlog check`：校验 `backlog.yaml` 是否与当前执行源一致（防止语义漂移）。
- `overview json`：从单一事实源聚合当前系统状态与待执行任务，输出结构化 JSON（默认产物：`artifacts/workflow/system-overview/latest.json`）。
- `overview serve`：启动本地 Node 看板服务（`/api/status` + `/api/action` + 前端页面），可直接查看与管理仓库状态。
- `docs/library-check.sh`：执行文档库逻辑校验与统一，支持 `all|index|rules|governance|gardening|experience`。

## 统一总览（单一数据源聚合）

聚合逻辑以 `backlog.yaml`（WorkItem）为管理主视图，并在过渡期由以下执行源同步生成：
- `docs/02-架构/执行计划/workflow-map.yaml`
- `docs/02-架构/技术债清单.md`
- `docs/02-架构/执行计划/active/PLAN-20260227-工程智能化路线图.md`
- `git status --porcelain` 与 `artifacts/workflow/`

输出内容包括：
- 全局摘要：在制/完成 TD、CAP 完成度、待执行任务数量、工作区变更数
- `TD -> CAP` 联动视图：状态、验收命令、必需文档、最近一次流程报告
- 文档库模块视图：文档校验模块按钮（全量/分模块）与经验库文档清单
- 文档库状态灯：各模块最近一次执行结果（PASS/FAIL）与时间
- 任务清单：按优先级排序的可执行动作（`workflow.start/progress/close/full`、`cap.verify`、`ci.verify`）
- 操作执行结果：命令、退出码、日志摘要（stdout/stderr）

## CI 自动化联动

- 质量门禁：`scripts/ci/workflow-sync-check.sh`
  - 当改动命中 workflow map 的 `trigger_paths` 时，必须同步修改 `required_docs` 中至少一项。
- 定时巡检：`.github/workflows/tech-debt-sweep.yml`
  - 每日执行技术债治理检查与 workflow 联动检查。

## 推荐会话触发语句

- `启动 TD-001 闭环`
- `推进 TD-001`
- `闭环 TD-001`

协作约定：收到上述语句后，默认按 `start -> progress -> close` 执行，并同步输出结构化结果。
