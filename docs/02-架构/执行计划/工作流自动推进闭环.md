# 工作流自动推进与闭环（WorkItem）

本文定义执行计划的统一编排入口，目标是把“追踪-验证-推进-闭环”变成可执行流程，而非依赖会话记忆。

## 单一事实源

- 执行主源：`docs/02-架构/执行计划/backlog.yaml`
- 技术债清单（治理辅助）：`docs/02-架构/技术债清单.md`
- 路线图计划：`docs/02-架构/执行计划/active/PLAN-20260227-01-工程智能化路线图.md`
- ADR 索引：`docs/09-ADR-架构决策/ADR-索引.md`

语义约定：
- 最小单元统一为 `WorkItem`。
- 主键统一为 `WI-PLANYYYYMMDDNN-NN`。
- 每个 WorkItem 强约束唯一归属一个 `planId`。
- 详细编号策略见：`docs/02-架构/执行计划/WorkItem-最小单元与编号策略.md`

`workflow` 字段维护可执行规则：
- `triggerPaths`：触发路径
- `requiredDocs`：必需文档
- `acceptanceCmds`：验收命令列表
- `closeChecks`：闭环检查约束

## 命令入口

- 启动：`scripts/workflow/start.sh WI-PLANYYYYMMDDNN-01`
- 推进：`scripts/workflow/progress.sh WI-PLANYYYYMMDDNN-01`
- 闭环：`scripts/workflow/close.sh WI-PLANYYYYMMDDNN-01`
- 一键执行：`scripts/workflow/run.sh WI-PLANYYYYMMDDNN-01 full`
- 列出 WorkItem：`scripts/workflow/workitem-list.sh [todo|in_progress|blocked|done|all]`
- 新增 WorkItem：
  `scripts/workflow/workitem-add.sh --plan-id PLAN-YYYYMMDD-NN --kind debt --title "标题" --owner "repo-owner" --priority "P1"`
- 新建计划（自动生成 `PLAN-YYYYMMDD-NN` 与初始化 WorkItem）：
  `scripts/workflow/plan-add.sh --title "专题标题" --owner "repo-owner"`
- 统一入口：
  - `scripts/workflow/run.sh list all`
  - `scripts/workflow/run.sh plan-add --title "专题标题" --owner "repo-owner"`
  - `scripts/workflow/run.sh add --plan-id PLAN-YYYYMMDD-NN --kind debt --title "标题" --owner "repo-owner" --priority "P1"`
  - `scripts/workflow/run.sh autopilot --plans PLAN-YYYYMMDD-NN,PLAN-YYYYMMDD-NN --max-items-per-plan 1`
  - `scripts/workflow/run.sh backlog build`
  - `scripts/workflow/run.sh backlog check`
  - `scripts/workflow/run.sh overview json`
  - `scripts/workflow/run.sh overview serve 127.0.0.1 8787`

行为说明：
- `start`：在 `main` 自动创建工作分支、更新 WorkItem 状态、生成 checklist。
- `progress`：按 WorkItem 验收命令执行并生成报告。
- `close`：先重跑 `progress`，再做文档/依赖/ADR 闭环校验并产出报告。
- `workitem-add`：新增 WorkItem 到 `backlog.yaml`，然后执行 `backlog build` 规范化。
- `plan-add`：扫描 active/completed 目录，按 `PLAN-YYYYMMDD-NN` 自动分配当日下一个序号，并落地初始化计划文档 + 首个 WorkItem。
- `autopilot`：按计划列表串行推进（优先 in_progress，再处理 todo），并在每个计划结束后自动生成 handoff 文件，供新会话直接接力。
- `backlog build/check`：保证 backlog 结构稳定、编号合法、依赖可解析。

## 多计划全自动推进（Autopilot）

目标：在单次命令中自动推进多个计划，减少人工切换与长对话上下文污染。

示例：

```bash
scripts/workflow/run.sh autopilot \
  --plans PLAN-20260301-01,PLAN-20260301-02,PLAN-20260301-04 \
  --max-items-per-plan 1
```

可选参数：
- `--max-items-per-plan`：每个计划本轮最多推进多少个 WorkItem（默认 1）。
- `--continue-on-error`：某项失败后继续后续计划（默认失败即停止）。
- `--handoff-dir`：交接卡输出目录（默认 `artifacts/workflow/handoffs`）。

输出产物：
- 总结报告：`artifacts/workflow/autopilot/<run-id>/summary.md`
- 逐阶段结果：`artifacts/workflow/autopilot/<run-id>/result.tsv`
- 每计划交接卡：`artifacts/workflow/handoffs/<plan-id>-<run-id>.md`

交接卡内容：
- 本轮执行记录（WorkItem + phase + pass/fail）
- 当前计划剩余待执行项
- 下一会话可直接粘贴的启动提示词

## 推进过程追踪

每个 debt/task WorkItem 都会生成事件追踪：
- 全局事件流：`artifacts/workflow/events/<WI-ID>.jsonl`
- 单次运行事件：`artifacts/workflow/<WI-ID>/<run-id>/events.jsonl`
- 事件类型示例：
  - `workflow.start.requested/completed`
  - `workflow.progress.started/command/completed`
  - `workflow.close.started/completed/failed`

这套事件流用于回答“每一项计划到底推进到了哪一步”，而不只是最终状态。

## 统一总览（单一数据源聚合）

聚合逻辑以 `backlog.yaml` 为唯一执行视图，输出内容包括：
- 全局摘要：WorkItem 总量、状态分布、待执行任务数量、工作区变更数
- Plan 进度视图：每个 `planId` 的完成率与状态分布
- 任务清单：按优先级排序的可执行动作（`workflow.start/progress/close/full`、`ci.verify`）
- 操作执行结果：命令、退出码、日志摘要（stdout/stderr）

## CI 自动化联动

- `scripts/ci/workflow-sync-check.sh`
  - 按 `backlog.yaml` 规则执行文档联动检查。
- `scripts/workflow/backlog.sh check`
  - 校验 `backlog.yaml` 结构与编号规则。
- `scripts/ci/plan-template-check.sh`
  - 校验 active 计划模板、编号规则、唯一归属与 backlog 对齐。

## 推荐会话触发语句

- `启动 WI-PLAN2026022701-11 闭环`
- `推进 WI-PLAN2026022701-11`
- `闭环 WI-PLAN2026022701-11`

协作约定：收到上述语句后，默认按 `start -> progress -> close` 执行，并同步输出结构化结果。
