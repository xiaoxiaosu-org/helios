# ADR-20260228: CAP-004 架构边界依赖门禁落地

## 状态
Accepted

## 日期
2026-02-28

## 背景
- 执行计划中 CAP-004 要求把“架构边界/依赖方向”从约定升级为可机械验证的硬门禁。
- 现状缺少 `scripts/ci/arch-check.sh` 与对应规则文件，`scripts/cap/verify.sh CAP-004` 处于阻塞状态。

## 决策
- 新增 `scripts/ci/arch-check.sh`，统一校验 `apps/services/modules/src` 的依赖方向。
- 新增规则文件 `docs/02-架构/边界与依赖规则.md`，作为校验的单一事实来源。
- 将 `arch-check` 接入 CI（`quality-gates.yml`）与本地聚合门禁（`scripts/ci/verify.sh`）。
- 违规则强制失败，并在输出中提供“下一步修复指令”。

## 影响

### 正面影响
- 架构边界违规可在 PR 阶段被阻断，避免“上线后才发现反向依赖”。
- 规则与脚本形成闭环，减少口头约定和解释成本。

### 负面影响
- 对历史代码引入新增约束，可能导致首轮接入时出现存量整改成本。
- 多语言 import 解析基于静态模式，复杂动态加载场景可能出现漏检/误报，需逐步迭代规则。

## 备选方案
- 仅保留文档约定，不上 CI 门禁：拒绝，无法机械验证且容易退化。
- 引入重型架构分析平台：暂不采用，当前仓库规模下成本高于收益，先用轻量脚本起步。

## 版本影响
- 是否影响 API：否
- 是否影响事件模型：否
- 是否影响数据结构：否
