# ADR-20260228: Git 门禁闭环补强（分支前置、CAP 完成后提交提醒、清单联动阻断）

## 状态
- 已采纳

---

## 背景

当前治理规则虽已覆盖提交/PR 门禁，但仍存在三个闭环缺口：
- 协作执行层面未强制“接到需求先切分支再改动”，导致可能在 `main` 上先产生改动或提交。
- CAP 验收通过后缺少统一“提交 -> 推送 -> PR”提醒，容易停留在本地通过。
- Git 门禁相关实现文件变更时，虽有文档约定“应更新对照清单”，但缺少 CI 直接阻断。

---

## 决策

采用“规则文本 + 执行脚本 + CI 阻断”三层同步补强：
- 在 `AGENTS.md`、治理文档与流程文档中明确：
  - 接到实现需求后，若在 `main`，必须先创建工作分支再改动。
  - `scripts/cap/verify.sh CAP-00X` 成功后，必须推进提交/PR 闭环。
- 在 `scripts/cap/verify.sh` 成功路径输出下一步闭环提醒，并带证据目录引用提示。
- 在 `doc-check.yml` 增加门禁步骤：当 Git 门禁相关实现/规则文件变更时，若未更新 `docs/02-架构/工程治理/Git门禁与模板对照清单.md` 则直接失败。
- 在 `scripts/docs/git-governance-sync-check.sh` 增加一致性校验，确保上述规则在文档与工作流中持续存在。

---

## 影响

### 正面影响
- 分支策略前置，降低 `main` 上误操作概率。
- CAP 验收不再停留在“本地通过”，提升交付闭环完成率。
- Git 门禁规则与唯一信息源文档建立强联动，减少规则漂移。

### 负面影响
- Git 门禁相关文件每次变更都需同步更新对照清单，短期增加文档维护成本。
- CI 会新增一次阻断场景，初期可能暴露既有协作习惯不一致问题。

---

## 替代方案

- 仅保留文档约定，不加 CI 阻断：成本低，但无法防止遗漏。
- 仅依赖本地 hook：容易被未安装 hook 或 `--no-verify` 绕过。
- 仅在评审中人工检查：一致性依赖人，无法稳定执行。

---

## 版本影响

- 是否影响 API：否
- 是否影响事件模型：否
- 是否影响数据结构：否
