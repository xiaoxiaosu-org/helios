# HELIOS — AGENTS.md（项目说明 + 工程流程 + 文档治理）

本文件位于 HELIOS 仓库根目录，用于约束人类开发者与 Codex/ClaudeCode 等智能体在本仓库内的所有实现与变更方式，确保：
- 语言与术语一致
- 开发流程可控
- 产出物（代码/文档/决策记录）长期可维护
- 任何功能都有文档支撑、可追溯、可复盘
- 关键变更可审计、可回滚、可灰度

目标：产品化交付级（工程治理与交付标准优先）。

---

## 0. 项目描述（你正在构建什么）

HELIOS 是“工业智能操作系统”原型：面向复杂工业流程场景，提供从信息整合、流程编排执行、实时状态计算、决策与安全控制、异常韧性处理，到全链路可观测与可溯源的闭环能力。

当前阶段优先级：
1) 文档体系与工程约束先跑通  
2) 统一术语与契约表达方式  
3) 可追溯、可审计的交付机制（门禁/模板/Owner/ADR）

---

## 1. AGENTS.md 分层规则（根目录与子目录）

1) 根目录 `AGENTS.md` 为全局强制规则，适用于仓库所有目录。  
2) 任意子目录可新增 `AGENTS.md` 用于补充该目录的边界与细则，但只允许：
   - **追加更严格规则**
   - **禁止与根规则冲突**
   - 禁止“放宽要求”
3) 智能体/人类执行顺序（避免含糊）：
   - **根目录规则 → 父目录链（由远到近） → 当前目录规则**
   - **近处规则优先**（仅可更严格，不得放宽）

---

## 2. 项目语言（统一术语与命名）

### 2.1 核心术语（必须使用这些词，避免自造同义词）
- WorkflowDefinition：流程定义（静态）
- WorkflowInstance：流程实例（运行态）
- Step：步骤（可执行单元）
- Action：动作（具体执行/控制命令）
- Signal：原始采集数据（输入）
- State：派生状态（可计算事实）
- Metric：指标（可对比的数值/统计）
- Evidence：证据包（支撑结论的数据片段/计算过程/版本信息）
- Decision：决策（策略输出，驱动 Action 或结论）
- Event：事件（跨组件通信/状态变化通知）
- Trace：全链路追踪标识与上下文

### 2.2 术语落地要求
- 新增术语：必须同步更新 `docs/00-术语表/术语表.md`
- 命名风格：面向业务含义，避免缩写与单字母变量名
- 日志语言：中文描述，示例：`log.info("方法名 >>> 发生了什么")`

---

## 3. 文档体系（Docs-as-Code）

### 3.1 docs 一等公民原则
所有架构、领域、接口、事件、数据与关键决策必须沉淀到 `docs/` 中，并且能通过代码变更追溯到对应文档更新。

### 3.2 docs 顶层结构固定（00-09 固定）
`docs/00-09` 顶层目录结构固定，不得随意增删/改名。任何“顶层语义变化”必须走 ADR。

> 说明（消除冲突）：  
> - **允许**在某个顶层目录内新增二级/多级子目录（如按业务域/服务拆分），这不视为“顶层结构调整”，**不需要 ADR**。  
> - 但如果新增子目录会改变该顶层目录的语义边界，则必须 ADR。

目录结构（顶层固定，允许内部扩展）：

    docs/
    ├── 00-术语表/
    ├── 01-产品/
    ├── 02-架构/
    ├── 03-领域模型/
    ├── 04-接口/
    ├── 05-事件/
    ├── 06-数据/
    ├── 07-运行态/
    ├── 08-安全/
    └── 09-ADR-架构决策/

### 3.3 文档放置边界（避免重复）
1) 先问“这是目标/边界、设计、契约、数据、运行行为、安全控制还是决策原因？”
2) “为什么这样做”放 `09-ADR`，“做成什么样”放 `02-08`。
3) “字段级契约”只放 `04-接口` 或 `05-事件`，不要塞进 `02/03`。
4) “不变量/状态迁移规则”放 `03-领域模型`。
5) “表结构/索引/保留策略”放 `06-数据`。
6) “trace/窗口/回放”放 `07-运行态`，架构文档只保留概览与链接。

### 3.4 分级与索引规则（不改顶层结构）
- 每个顶层目录必须有 1 个“总览/索引页”。
- 当单目录文件数 > 7 或出现“找文档变慢”，允许在该顶层目录内按“业务域/服务名”拆二级子目录（无需 ADR，除非改变目录语义）。
- `04-接口/OpenAPI/` 与 `05-事件/Schemas/`：只放机器产物；人工说明放同层 Markdown，不混写。

---

## 4. 开发流程（必须遵守）

### 4.1 先契约，后实现（契约优先）
任何功能实现必须先明确契约表达（至少一种）：
- API 契约（HTTP/gRPC/SDK）
- Event 契约（事件 schema + 版本策略）
- Domain 契约（领域对象/状态机/约束）
- Data 契约（表结构/迁移脚本/索引策略）

不允许“先把 Service 写出来再补契约”。

### 4.2 最小可行变更
- 只改与本需求直接相关的内容
- 不做无关重构
- 修改范围越小越好，避免引入隐性风险

### 4.3 可追溯性强制
所有关键链路必须携带并记录：
- traceId（必需）
- workflowInstanceId（涉及流程时必需）
- stepId（涉及步骤时必需）

并能在日志、事件、持久化记录中关联查询。

### 4.4 失败可控（必须考虑降级与恢复）
凡是涉及执行/控制/关键状态写入的逻辑，必须明确：
- 失败处理方式（重试/回滚/补偿/降级/人工接管）
- 超时策略
- 幂等策略（重复请求/重复事件的处理）

---

## 5. 变更类型与破坏性变更判定（统一标准）

### 5.1 什么算“破坏性变更”（Breaking Change）
API：
- 删除接口/路径/方法
- 新增必填字段或字段语义改变
- 响应字段删除/语义改变
- 错误码语义改变导致调用方无法兼容

事件：
- 删除事件类型
- 新增必填字段或字段语义改变
- 字段类型改变（string -> int 等）
- 投递语义改变（至少一次/至多一次、顺序保证等）

数据：
- 删除表/字段/索引导致读写方不兼容
- 字段类型/含义改变导致历史数据不可用
- 迁移不可回滚且无补偿方案

### 5.2 兼容期与废弃流程（deprecate -> warn -> remove）
- 破坏性变更必须：
  1) 先进入弃用（Deprecate）：文档标记弃用与替代方案
  2) 兼容期：默认至少保留 **1 个稳定版本周期**
  3) 移除（Remove）：兼容期结束后才允许移除旧契约
- “稳定版本周期”定义：
  - 若项目已有发布节奏：以 **release tag** 为单位（至少跨 1 次 release）
  - 若项目尚未建立发布节奏：默认按自然时间 **4 周**；如需调整必须 ADR（可覆盖为 2 周/8 周等）

### 5.3 迁移策略（数据与协议）
默认推荐“扩展-收缩（expand-contract）”：
1) 先扩展：新增字段/新表/新事件版本，保持旧路径仍可用  
2) 双写/兼容：一段时间内同时支持旧/新  
3) 再收缩：兼容期后移除旧字段/旧表/旧事件  

必须具备：
- 迁移步骤说明
- 校验方式（如何确认迁移成功）
- 回滚/补偿方案（不能回滚则必须说明补偿与降级）

---

## 6. 例外流程（让规则能跑起来）

### 6.1 Hotfix（线上紧急修复）
允许先合入最小止血修复，但必须：
- 变更范围：只允许“止血级”最小改动
- 不能破坏 trace/审计链路
- 必须新增临时记录：`docs/09-ADR-架构决策/HOTFIX-YYYYMMDD-简短标题.md`

> 重要说明（消除命名/语义冲突）：  
> - `HOTFIX-*` 是**临时记录**，用于“紧急修复先过门禁 + 明确补档承诺”。  
> - `HOTFIX-*` **不属于 ADR**，不受 `ADR-*` 命名规则约束，也不代表“决策已被接受”。  
> - `HOTFIX-*` 不需要写入 `ADR-索引.md`（索引只收录 `ADR-*`）
> - 若 Hotfix 过程中触发了需要沉淀的决策（如兼容策略、边界调整、安全策略变化等），必须**另外新增**：`ADR-YYYYMMDD-简短标题.md`，并在 HOTFIX 中链接到该 ADR。

补档时限（默认）：
- 24 小时内补齐：相关 docs 更新
- 48 小时内补齐：必要 ADR（若触发破坏性变更/边界变化/安全变化）

### 6.2 探索性 PoC
允许 PoC 存在，但 PoC 不得直接作为正式能力进入主干，除非补齐契约/文档/测试/门禁要求。

PoC 最小可追溯要求（必须具备）：
- **PoC 必须明确标记**：在代码或目录说明中标注 `PoC`（例如目录名、README 标记、包说明）。
- **至少提供一份最小 PoC 文档**（可放在 PoC 目录下 `README-PoC.md` 或放入 `docs/` 的对应目录），必须包含：
  - 目标
  - 范围
  - 结论（验证结果/数据/截图/日志要点）
  - 下一步（是否进入正式化、缺口、风险）

---

## 7. 文档更新触发清单（只要发生就必须更新 docs）

1) 新增/修改对外接口（HTTP/gRPC/SDK）
- 必更：`docs/04-接口/`（接口说明 + OpenAPI 导出）
- 破坏性变更：必须 ADR + 兼容期说明

2) 新增/修改事件或事件字段
- 必更：`docs/05-事件/`（事件说明 + Schema + 版本与兼容策略）
- 破坏性变更：必须升版本 + ADR

3) 新增/修改数据结构（表/字段/索引/迁移）
- 必更：`docs/06-数据/`
- 破坏性变更或迁移风险：必须 ADR + 迁移/回滚说明

4) 新增/修改领域对象/状态机/关键约束
- 必更：`docs/03-领域模型/`
- 影响运行态：同时必更 `docs/07-运行态/`
- 引入新机制：必须 ADR

5) 新增/修改安全/权限/审计/降级策略
- 必更：`docs/08-安全/`
- 必须 ADR（强制项）

6) 调整系统边界、依赖方向、引入新基础设施/框架
- 必更：`docs/02-架构/`
- 必须 ADR（强制项）

---

## 8. 可观测与可追溯（最低标准）

### 8.1 Trace 传播
- 必须携带 traceId（跨服务、跨线程、跨事件都不能丢）

### 8.2 日志最低字段（建议结构化输出）
至少应可检索关联（按场景择必填）：
- traceId（必填）
- workflowInstanceId、stepId（涉及流程时必填）
- actionId / eventId / requestId（按调用类型）
- serviceName、version、env
- result（成功/失败）、errorCode（失败时）、durationMs（耗时）
- 关键业务标识（按领域约定）

---

## 9. 安全基线（最低门槛）

必须满足：
1) 鉴权与授权：对外接口必须有明确鉴权/授权策略与失败响应
2) 输入校验：外部输入必须校验（类型、范围、长度、枚举）
3) 审计日志：关键操作必须记录可追溯字段（谁、何时、做了什么、结果）
4) 密钥治理：禁止在代码/文档/日志/ADR 中出现 Token/密码/私钥；必须可被扫描阻断
5) 依赖漏洞扫描：
   - **生产发布（打 release tag / 生产部署）前必须执行依赖漏洞扫描**
   - 若尚无正式发布流程：在合并到主干前建议执行（不作为硬失败门禁）

安全策略发生变化：必须 ADR。

### 9.1 安全编码红线（强制）

1) 禁止硬编码密钥
- 禁止在代码、文档、日志、ADR 中出现 Token / 密码 / 私钥 / AccessKey 等敏感信息
- 敏感配置必须通过环境变量或密钥管理器注入，并可被扫描阻断

2) 输入验证必须在系统边界执行
- 所有外部输入（HTTP、事件、文件、CLI 参数、第三方回调）必须进行类型、范围、长度、枚举校验
- 应优先使用 schema/约束工具（如 Zod、Bean Validation、DRF Serializer 等），不得依赖“调用方自觉”

3) 数据访问必须参数化
- 禁止字符串拼接 SQL
- ORM / QueryBuilder / Prepared Statement 视为参数化查询实现方式（前提是不回退为拼接）

4) CSRF 必须按鉴权模式明确处理
- 基于 Cookie 的会话鉴权：状态变更操作必须启用 CSRF 防护
- 纯 Bearer Token 且无 Cookie 的 API：可不启用 CSRF，但必须在 `docs/08-安全/` 明确说明边界、前提与替代控制
- 若 CSRF 策略发生变化：按本文件第 7、9、10 节要求更新文档并补 ADR（如适用）

---

## 10. ADR（架构决策记录）规则

### 10.1 必须写 ADR 的场景
- 新机制/新抽象/新中间件引入
- 破坏性变更（接口/事件/数据不兼容）
- 系统边界与依赖方向变化
- 安全/审计策略变化
- 重大性能与容量策略变化（保留/归档/回放/窗口模型等）

### 10.2 命名、状态与索引
- 存放：`docs/09-ADR-架构决策/`
- ADR 命名：`ADR-YYYYMMDD-简短标题.md`
  - **说明**：ADR 命名规则仅适用于 `ADR-*` 文件，不约束 `HOTFIX-*` 文件
- 必须基于：`docs/09-ADR-架构决策/ADR-模板.md`
- 新增 ADR 时必须更新：`docs/09-ADR-架构决策/ADR-索引.md`
- ADR 状态：Proposed / Accepted / Superseded / Deprecated（在 ADR 内明确标记）

---

## 11. Owner 与审批机制（让规则长期有效）

必须建立 Owner 机制（推荐使用 `CODEOWNERS`）：
- `docs/00-术语表/**`：术语 Owner
- `docs/02-架构/**`、`docs/09-ADR-架构决策/**`：架构 Owner
- `docs/08-安全/**`：安全 Owner
- 各服务/模块目录：对应服务 Owner

审批最低要求：
- ADR：必须由“架构 Owner”审批
- 安全策略相关：必须由“安全 Owner”审批
- 破坏性变更：必须由调用方/订阅方 Owner 至少一方确认（通过 PR Review 体现）

---

## 12. 质量门禁（必须通过）

### 12.1 最低测试标准（量化口径）
- 改动契约（API/事件/数据）：必须提供至少 1 种可重复验证方式（契约测试/集成测试/回放样例+校验脚本）
- 改动事件消费逻辑：必须验证幂等（重复事件不出错）与异常路径（失败重试/补偿）
- 改动迁移脚本/表结构：必须提供迁移步骤与校验方式；不可回滚时必须有补偿与降级说明

### 12.2 PR / DoD（完成定义）清单（必须勾选）
- [ ] 变更目标与范围明确（不做无关重构）
- [ ] 已更新对应 docs（按第 7 节触发清单）
- [ ] 若触发破坏性变更：已给出兼容期与废弃流程（第 5 节）
- [ ] 若触发 ADR：已新增 ADR 且更新 ADR-索引（第 10 节）
- [ ] 已满足最低测试标准（第 12.1）
- [ ] traceId 与关键业务标识未丢失（第 8 节）
- [ ] 若涉及安全：已更新安全文档并通过安全 Owner Review（第 9、11 节）

### 12.3 CI 门禁建议（路径不写死，避免后续漏检）
- 业务代码目录变更必须改 docs/：
  - 当前仓库默认业务代码目录为 `modules/**`
  - 若未来新增 `apps/**`、`services/**`、`src/**` 等目录，必须同步更新 CI/校验脚本与本条款
- OpenAPI 与 Schemas 产物必须可生成且 diff 可评审
- 架构/安全/ADR 变更必须触发 Owner Review
- 标准输出调试语句（如 `console.log`、`print`、`System.out.println`）必须可被检测并阻断（按语言栈配置）
- 合并前建议执行 secrets 扫描；生产发布前必须执行（可结合第 9 节与发布流程）
- 测试覆盖率阈值必须在 CI 中可校验（至少与项目最低标准一致）

### 12.4 编码与结构规范（强制）
- 多个小文件优于少量大文件；保持高内聚、低耦合
- 文件规模建议：典型 200-400 行；超过 800 行必须拆分或在 PR 中给出合理说明
- 按功能/领域组织代码，不按“controller/service/util 纯类型分层”机械平铺
- 默认不可变；需要可变状态时必须局部化、可解释、可测试
- 生产代码禁止标准输出调试语句（如 `console.log`、`print`、`System.out.println`）；应使用统一日志机制
- 错误处理必须明确：异常语义/错误码（或等价错误分类）/可观测字段（至少 traceId 与结果）
- 系统边界必须做输入验证，不得直接信任外部输入
- 代码、注释与正式工程文档默认不使用表情符号（PoC 演示材料除外）

### 12.5 工程化门禁（Lint / 覆盖率 / Secrets 扫描）
- 必须配置并执行代码规范检查（Lint / 静态检查）；包含“禁止标准输出调试语句”的等价规则
- 测试覆盖率阈值默认不低于 80%（项目可提高；如降低必须说明并评审确认）
- 覆盖率口径至少明确一种（行覆盖率或分支覆盖率）；CI 输出需可审计
- secrets 扫描建议在合并前执行；生产发布前必须执行并保留结果或记录
- 硬失败门禁（默认）：构建失败、类型检查失败、Lint 失败、测试失败、覆盖率未达标、发现未豁免 secrets
- 软失败/警告项（如适用）必须在 PR 中记录原因与后续处理计划

---

## 13. 每次交付输出清单（必须同时提交）

每次实现或修改任何功能，必须同时提交：
1) 代码变更（实现 + 必要测试）
2) docs 变更（按第 7 节触发清单）
3) 若触发 ADR：新增 ADR 文件，并在相关文档中引用

若无法判断应更新哪些文档，默认至少更新：
- `docs/02-架构/系统总览.md`（影响面说明）
- `docs/03-领域模型/核心领域模型.md`（对象/状态变化）
- `docs/04-接口/接口总览.md` 或 `docs/05-事件/事件总览.md`（契约变化）

补充说明（规则与落地分层）：
- `AGENTS.md` 负责定义强制规则与门禁标准（必须/禁止/触发条件）
- 具体落地流程、命令剧本、模板与检查步骤优先复用现有 skills（如 `verification-loop`、`security-review`、`command-playbooks-zh`、`typescript-rules-zh`、`engineering-rules-common-zh`）

---

## 附录 A：docs 各目录边界定义表（评审级约束）

| 目录 | 主要回答的问题 | 应该放什么 | 不应该放什么 | 触发更新（典型） | 与其他目录关系 |
|---|---|---|---|---|---|
| docs/00-术语表/ | 我们在说什么？词是什么意思？ | 术语定义、统一命名规范、中英文映射、禁用同义词 | 业务流程、接口字段细节、实现代码 | 新术语、新命名约定 | 为所有目录提供统一语言基线 |
| docs/01-产品/ | 为什么做、给谁做、边界在哪？ | 产品愿景、范围边界、角色与权限模型（产品视角）、路线图 | 技术架构细节、表结构、API字段级定义 | 范围变化、角色变化、里程碑调整 | 输入给 02/03/04/08 |
| docs/02-架构/ | 系统怎么分层、模块如何协作？ | 系统总览、模块边界、依赖规则、运行时拓扑、可观测总体方案 | 具体接口字段、事件schema、DDL字段清单 | 新模块/依赖变化/基础设施引入 | 约束 03/04/05/06/07/08 |
| docs/03-领域模型/ | 核心业务对象是什么？状态如何演化？ | 领域对象、状态机、生命周期、不变量、领域约束 | 传输协议细节、数据库DDL、部署方案 | 新对象/状态迁移/约束变化 | 映射到 04/05/06/07 |
| docs/04-接口/ | 对外怎么调用？契约是什么？ | API总览、接口约定、错误码、请求响应契约、OpenAPI导出 | 领域决策原因、事件兼容策略、数据库实现细节 | 新增/修改接口 | 契约落地层，受 03 约束 |
| docs/05-事件/ | 系统间如何通过事件通信？如何兼容？ | 事件总览、schema、版本策略、兼容说明、发布/订阅语义 | API字段说明、数据库表结构、内部实现细节 | 新事件/字段变更/兼容策略调整 | 契约落地层，与 07 强关联 |
| docs/06-数据/ | 数据怎么存、怎么查、性能约束？ | 存储总览、数据模型、表结构、索引、保留/归档、迁移注意事项 | 业务目标、接口调用示例、运行态流程图 | 表/字段/索引/迁移变更 | 支撑 04/05/07 |
| docs/07-运行态/ | 运行上下文如何传递、计算、回放？ | Trace规范、上下文模型、缓存/窗口、回放复盘机制 | 架构总览重复描述、字段级契约、DDL细节 | Trace规则/窗口模型/回放机制变更 | 连接 02 与 03/05/06 |
| docs/08-安全/ | 如何鉴权、审计、降级、控风险？ | 权限与审计、风险与降级、安全边界与控制点 | 产品路线图、字段级契约、纯实现细节 | 权限/审计/降级变化 | 横切 02/04/05/06/07 |
| docs/09-ADR-架构决策/ | 为什么这样设计？ | ADR 模板、索引、决策记录、状态流转 | 操作手册、常规接口说明、重复架构正文 | 新机制/破坏性变更/边界变化/安全重大调整 | 为 02-08 提供决策依据 |
